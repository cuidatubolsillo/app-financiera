================================================================================
PROMPTS DE IA - APLICACI√ìN DE AN√ÅLISIS DE ESTADOS DE CUENTA
================================================================================

Fecha de generaci√≥n: 2025-01-XX
Modelo utilizado: Claude Haiku 4.5 (claude-haiku-4-5)
Sistema: App Financiera - An√°lisis de PDFs con IA

================================================================================
‚úÖ ESTADO ACTUAL - UN SOLO PROMPT
================================================================================

DESPU√âS DE REVISAR Y LIMPIAR EL C√ìDIGO:

‚úÖ PROMPT √öNICO: SIEMPRE SE USA
   - Ubicaci√≥n: pdf_analyzer.py l√≠nea 116-195
   - Llamada: analyzer.analizar_estado_cuenta(temp_path, extraer_movimientos_detallados=True)
   - Estado: ACTIVO - Se ejecuta en cada an√°lisis de PDF
   - Max Tokens: 8000 (fijo)
   - Siempre extrae movimientos detallados completos

‚ùå PROMPT B√ÅSICO: ELIMINADO
   - Fue eliminado del c√≥digo el [fecha]
   - Ya no existe en pdf_analyzer.py
   - El c√≥digo ahora es m√°s simple y directo

CARACTER√çSTICAS:
- Un solo prompt optimizado para extracci√≥n completa
- Siempre incluye movimientos detallados
- Texto completo del PDF (sin l√≠mites)
- Max tokens fijo: 8000

================================================================================
√çNDICE
================================================================================

1. PROMPT √öNICO (con movimientos detallados) - ‚úÖ EL √öNICO PROMPT ACTIVO
2. CONFIGURACI√ìN DE LA API
3. PAR√ÅMETROS DE LLAMADA
4. AN√ÅLISIS DE USO EN EL C√ìDIGO

================================================================================
1. PROMPT √öNICO (con movimientos detallados)
================================================================================

Este es el √öNICO prompt que existe en la aplicaci√≥n. Siempre extrae TODOS los 
movimientos detallados del estado de cuenta.

Max Tokens: 8000 (fijo)
Texto completo del PDF: Se incluye completo (sin l√≠mites)

-------------------------------------------------------------------------------
PROMPT:
-------------------------------------------------------------------------------

Analiza este texto de estado de cuenta bancario y extrae EXACTAMENTE los siguientes campos en formato JSON:

{
    "fecha_corte": "DD/MM/YYYY",
    "fecha_inicio_periodo": "DD/MM/YYYY",
    "fecha_pago": "DD/MM/YYYY", 
    "cupo_autorizado": 0.00,
    "cupo_disponible": 0.00,
    "cupo_utilizado": 0.00,
    "deuda_anterior": 0.00,
    "consumos_debitos": 0.00,
    "otros_cargos": 0.00,
    "consumos_cargos_totales": 0.00,
    "pagos_creditos": 0.00,
    "intereses": 0.00,
    "minimo_a_pagar": 0.00,
    "deuda_total_pagar": 0.00,
    "nombre_banco": "NOMBRE_BANCO",
    "tipo_tarjeta": "TIPO_TARJETA",
    "ultimos_digitos": "XXX",
    "movimientos_detallados": [
        {
            "fecha": "DD/MM/YYYY",
            "descripcion": "DESCRIPCION_COMPLETA",
            "monto": 0.00,
            "categoria": "CATEGORIA",
            "tipo_transaccion": "consumo|pago|interes|cargo|otro"
        }
    ]
}

üîç **INSTRUCCIONES CR√çTICAS PARA MOVIMIENTOS DETALLADOS:**

**EXTRACCI√ìN EXHAUSTIVA:**
- Incluye TODOS los movimientos, sin excepci√≥n
- Si ves "renovacion plan recompensa" 2 veces, incluye ambas
- Si hay movimientos similares o duplicados, incl√∫yelos TODOS
- NO omitas ning√∫n movimiento por peque√±o que sea

**FORMATO DE DESCRIPCI√ìN:**
- Usa la descripci√≥n EXACTA del documento
- Mant√©n may√∫sculas, min√∫sculas y caracteres especiales
- No modifiques ni resumas las descripciones

**MONTO:**
- SIEMPRE positivo (usar abs() si es necesario)
- Usar tipo_transaccion para distinguir pagos de consumos

**FECHA:**
- Formato exacto DD/MM/YYYY
- Si no hay fecha espec√≠fica, usar fecha de corte
- "fecha_inicio_periodo": Busca la fecha de inicio del periodo del estado de cuenta (fecha "desde", "periodo desde", "inicio periodo")
- Esta fecha indica desde cu√°ndo comienza el periodo que cubre el estado de cuenta

**CATEGORIZACI√ìN:**
- "Alimentaci√≥n": restaurantes, supermercados, comida r√°pida, cafeter√≠as
- "Transporte": gasolina, taxi, uber, transporte p√∫blico, peajes
- "Entretenimiento": cine, streaming, juegos, deportes
- "Salud": farmacias, m√©dicos, hospitales, seguros m√©dicos
- "Servicios": servicios p√∫blicos, internet, tel√©fono, seguros
- "Compras": tiendas, ropa, electr√≥nicos, hogar
- "Otros": todo lo que no encaje en las categor√≠as anteriores

‚ö†Ô∏è **VERIFICACI√ìN OBLIGATORIA:**
- Cuenta manualmente los movimientos antes de incluir
- Si encuentras 10 movimientos, el array debe tener 10 elementos
- Si encuentras 25 movimientos, el array debe tener 25 elementos
- NO omitas movimientos duplicados o similares

5. BUSCAR EN TODAS LAS SECCIONES:
   - Secci√≥n de consumos locales
   - Secci√≥n de consumos internacionales  
   - Secci√≥n de cargos autom√°ticos
   - Secci√≥n de intereses y comisiones
   - Secci√≥n de pagos realizados
   - Cualquier otra secci√≥n con movimientos

6. FORMATO DE DESCRIPCI√ìN:
   - Mant√©n la descripci√≥n original del establecimiento
   - Si hay c√≥digos o n√∫meros, incl√∫yelos
   - Ejemplo: "SUPERMERCADO WALMART 1234" en lugar de solo "WALMART"

TEXTO COMPLETO DEL ESTADO DE CUENTA:
{texto_pdf}

-------------------------------------------------------------------------------
NOTAS SOBRE ESTE PROMPT:
-------------------------------------------------------------------------------

- Incluye el texto COMPLETO del PDF (sin l√≠mite de caracteres)
- Siempre extrae todos los movimientos individuales
- Genera hasta 8000 tokens de salida
- Ubicaci√≥n en c√≥digo: pdf_analyzer.py l√≠nea 116-195
- Se ejecuta en: app.py l√≠nea 1119 (ruta /analizar-pdf)
- Tambi√©n se usa en: diagnosticar_pdf.py l√≠nea 29

================================================================================
2. CONFIGURACI√ìN DE LA API
================================================================================

CLIENTE:
--------
Cliente: Anthropic
Biblioteca: anthropic (Python)
API Key: ANTHROPIC_API_KEY (variable de entorno)

MODELO:
-------
Modelo: claude-haiku-4-5
Versi√≥n: Claude Haiku 4.5
Tipo: Modelo de texto (no vision)

INICIALIZACI√ìN:
---------------
```python
from anthropic import Anthropic

self.api_key = os.environ.get('ANTHROPIC_API_KEY')
self.client = Anthropic(api_key=self.api_key)
```

================================================================================
3. PAR√ÅMETROS DE LLAMADA
================================================================================

LLAMADA A LA API:
-----------------
```python
response = self.client.messages.create(
    model="claude-haiku-4-5",
    max_tokens=max_tokens,  # 8000 o 4000 seg√∫n el tipo
    messages=[{
        "role": "user",
        "content": prompt
    }]
)
```

PAR√ÅMETROS:
-----------
- model: "claude-haiku-4-5" (fijo)
- max_tokens: 8000 (fijo - siempre an√°lisis completo)
- messages: Array con un solo mensaje del usuario
  * role: "user"
  * content: El prompt completo (string)

RESPUESTA:
----------
La respuesta viene en formato:
```python
response.content[0].text  # Texto de la respuesta
```

PROCESAMIENTO:
--------------
1. Se extrae el texto de la respuesta
2. Se busca el JSON entre las primeras llaves { }
3. Se parsea el JSON
4. Se validan los campos requeridos
5. Se formatean los datos

VALIDACI√ìN:
-----------
Campos requeridos que se validan:
- fecha_corte
- fecha_inicio_periodo (nuevo)
- fecha_pago
- cupo_autorizado
- cupo_disponible
- cupo_utilizado
- deuda_anterior
- consumos_debitos
- otros_cargos
- consumos_cargos_totales
- pagos_creditos
- intereses
- minimo_a_pagar (nuevo)
- deuda_total_pagar
- nombre_banco
- tipo_tarjeta
- ultimos_digitos
- movimientos_detallados (siempre se extraen)

Si falta un campo:
- Para strings (nombre_banco, tipo_tarjeta, ultimos_digitos): Se asigna ""
- Para n√∫meros: Se asigna 0.00
- Para movimientos_detallados: Se asigna []

================================================================================
4. ESTRUCTURA DE RESPUESTA ESPERADA
================================================================================

FORMATO JSON ESPERADO:
----------------------

El prompt siempre devuelve el formato completo con movimientos detallados:
{
    "fecha_corte": "15/01/2025",
    "fecha_inicio_periodo": "16/12/2024",
    "fecha_pago": "05/02/2025",
    "cupo_autorizado": 5000.00,
    "cupo_disponible": 2500.00,
    "cupo_utilizado": 2500.00,
    "deuda_anterior": 0.00,
    "consumos_debitos": 2000.00,
    "otros_cargos": 500.00,
    "consumos_cargos_totales": 2500.00,
    "pagos_creditos": 0.00,
    "intereses": 0.00,
    "minimo_a_pagar": 250.00,
    "deuda_total_pagar": 2500.00,
    "nombre_banco": "Banco Pichincha C.A.",
    "tipo_tarjeta": "Visa",
    "ultimos_digitos": "638",
    "movimientos_detallados": [
        {
            "fecha": "10/01/2025",
            "descripcion": "SUPERMERCADO WALMART 1234",
            "monto": 150.50,
            "categoria": "Alimentaci√≥n",
            "tipo_transaccion": "consumo"
        },
        {
            "fecha": "12/01/2025",
            "descripcion": "ESTACION DE SERVICIO SHELL",
            "monto": 45.00,
            "categoria": "Transporte",
            "tipo_transaccion": "consumo"
        }
    ]
}

================================================================================
5. PROCESAMIENTO POST-EXTRACCI√ìN
================================================================================

VALIDACI√ìN DE MOVIMIENTOS:
---------------------------
Siempre se validan los movimientos detallados (siempre se extraen):
- Se asegura que el monto sea siempre positivo (abs())
- Se valida que tenga los campos requeridos
- Se asigna "Otros" como categor√≠a por defecto si falta
- Se asigna "otro" como tipo_transaccion por defecto si falta

FORMATEO DE NOMBRES:
--------------------
- nombre_banco: Se capitaliza (primera letra may√∫scula)
- tipo_tarjeta: Se capitaliza (primera letra may√∫scula)

C√ÅLCULO DE PORCENTAJE:
----------------------
Se calcula autom√°ticamente:
porcentaje_utilizacion = (cupo_utilizado / cupo_autorizado) * 100

Si cupo_autorizado es 0, se asigna porcentaje_utilizacion = 0

================================================================================
6. COSTOS Y L√çMITES
================================================================================

MODELO: Claude Haiku 4.5
-------------------------
Precio: $0.25 por 1 MILL√ìN de tokens
Costo por token: $0.00000025

ESTIMACI√ìN DE TOKENS:
---------------------
- Input: Texto del PDF (puede ser 10,000+ caracteres)
- Output: JSON estructurado (var√≠a seg√∫n movimientos)
- Estimaci√≥n: ~1.3 tokens por palabra

COSTO ESTIMADO POR AN√ÅLISIS:
-----------------------------
- An√°lisis completo (√∫nico disponible): ~$0.0005 - $0.002

L√çMITES DE USUARIOS:
-------------------
- Usuarios normales: 50 usos por mes
- Administradores: Sin l√≠mite (999999)

================================================================================
7. MANEJO DE ERRORES
================================================================================

ERRORES POSIBLES:
-----------------

1. Error de API Key:
   - Mensaje: "ANTHROPIC_API_KEY no est√° configurado"
   - Soluci√≥n: Verificar variable de entorno

2. Error de extracci√≥n de texto:
   - Mensaje: "No se pudo extraer texto del PDF"
   - Soluci√≥n: Verificar que el PDF sea v√°lido

3. Error de parsing JSON:
   - Mensaje: "Error parseando JSON"
   - Soluci√≥n: La IA no devolvi√≥ JSON v√°lido

4. Error de validaci√≥n:
   - Mensaje: "Campos requeridos faltantes"
   - Soluci√≥n: Se asignan valores por defecto

RESPUESTA DE ERROR:
-------------------
```json
{
    "status": "error",
    "message": "Descripci√≥n del error",
    "raw_response": "Respuesta cruda de la IA",
    "method": "texto",
    "error_type": "TipoDeError"
}
```

================================================================================
8. AN√ÅLISIS DE USO EN EL C√ìDIGO
================================================================================

REVISI√ìN COMPLETA DEL C√ìDIGO:
-------------------------------

LUGARES DONDE SE LLAMA analizar_estado_cuenta:
-----------------------------------------------

1. app.py l√≠nea 1119 (Ruta: /analizar-pdf)
   C√≥digo:
   ```python
   resultado = analyzer.analizar_estado_cuenta(temp_path, extraer_movimientos_detallados=True)
   ```
   Estado: ‚úÖ ACTIVO - Se ejecuta cuando el usuario sube un PDF
   Prompt usado: √öNICO PROMPT (con movimientos detallados)

2. diagnosticar_pdf.py l√≠nea 29 (Script de diagn√≥stico)
   C√≥digo:
   ```python
   resultado = analyzer.analizar_estado_cuenta(pdf_path, extraer_movimientos_detallados=True)
   ```
   Estado: ‚úÖ ACTIVO - Se ejecuta cuando se usa el script de diagn√≥stico
   Prompt usado: √öNICO PROMPT (con movimientos detallados)

3. app.py l√≠nea 1329 (Ruta: /api/guardar-estado-cuenta)
   C√≥digo:
   ```python
   estado_cuenta = guardar_estado_cuenta(usuario_actual.id, datos_analisis, archivo_original, extraer_movimientos_detallados=True)
   ```
   Nota: Esta NO es una llamada a analizar_estado_cuenta, es a guardar_estado_cuenta
   Solo indica que se guardar√°n movimientos detallados

CONCLUSI√ìN FINAL:
-----------------
- Total de llamadas a analizar_estado_cuenta: 2
- Llamadas con extraer_movimientos_detallados=True: 2 (100%)
- Prompt √∫nico usado: 100% de las veces
- Max tokens: 8000 (fijo)

VALOR POR DEFECTO:
------------------
En pdf_analyzer.py l√≠nea 95:
```python
def analizar_estado_cuenta(self, pdf_path, extraer_movimientos_detallados=True):
```
El valor por defecto es True, y siempre se usa con este valor.

================================================================================
9. MEJORAS Y OPTIMIZACIONES
================================================================================

OPTIMIZACIONES ACTUALES:
------------------------
1. Se usa solo el texto del PDF (no im√°genes) para reducir costos
2. Se valida y limpia la respuesta antes de procesarla
3. Se registran m√©tricas de uso para control de costos
4. C√≥digo simplificado - un solo prompt (eliminado c√≥digo muerto)

POSIBLES MEJORAS FUTURAS:
--------------------------
1. Usar Claude Sonnet para an√°lisis m√°s complejos
2. Implementar cach√© de an√°lisis similares
3. Procesar PDFs con im√°genes usando visi√≥n
4. An√°lisis incremental (solo nuevos movimientos)
5. Opci√≥n de an√°lisis r√°pido (sin movimientos detallados) para vista previa

================================================================================
FIN DEL DOCUMENTO
================================================================================

