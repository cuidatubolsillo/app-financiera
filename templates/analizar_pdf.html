<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizar Estado de Cuenta - App Financiera</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .upload-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .upload-area {
            border: 3px dashed #28a745;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 30px;
        }
        
        .upload-area:hover {
            border-color: #1e7e34;
            background-color: #e9ecef;
        }
        
        .upload-area.dragover {
            border-color: #1e7e34;
            background-color: #d4edda;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #28a745;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 18px;
            color: #495057;
            margin-bottom: 10px;
        }
        
        .upload-subtext {
            font-size: 14px;
            color: #6c757d;
        }
        
        .file-input {
            display: none;
        }
        
        .btn-upload {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
        }
        
        .btn-upload:hover {
            background-color: #1e7e34;
        }
        
        .btn-analyze {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            display: none;
        }
        
        .btn-analyze:hover {
            background-color: #0056b3;
        }
        
        .btn-analyze:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .file-info {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-top: 30px;
            display: none;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .result-card h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .result-value {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }
        
        .result-value.date {
            color: #007bff;
        }
        
        .result-value.negative {
            color: #dc3545;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }
        
        .back-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .back-button:hover {
            background-color: #5a6268;
            color: white;
            text-decoration: none;
        }
        
        /* Pesta√±as de m√©todos */
        .method-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .tab-button {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        
        .tab-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .method-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        
        .method-info h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .method-info p {
            margin: 8px 0;
            color: #6c757d;
        }
        
        .method-used {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        /* Contador de usos de IA */
        .usage-counter {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .usage-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .usage-label {
            font-weight: 600;
            color: #495057;
        }
        
        .usage-count {
            background-color: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .usage-count.low {
            background-color: #ffc107;
            color: #212529;
        }
        
        .usage-count.exhausted {
            background-color: #dc3545;
        }
        
        .method-used h3 {
            margin: 0;
            color: #1976d2;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-container">
            <a href="{{ url_for('home') }}" class="back-button">‚Üê Volver al Men√∫</a>
            
            <h1>ü§ñ Analizar Estado de Cuenta con IA</h1>
            <p>Sube tu estado de cuenta en PDF y obt√©n un an√°lisis completo con inteligencia artificial</p>
            
                   <!-- Informaci√≥n del m√©todo -->
                   <div class="method-info">
                       <h3>üìù An√°lisis por Texto</h3>
                       <p><strong>M√©todo:</strong> Extracci√≥n de texto + Claude Haiku 4.5</p>
                       <p><strong>Ventajas:</strong> R√°pido, econ√≥mico, funciona con PDFs nativos</p>
                       <p><strong>Incluye:</strong> Todos los tipos de d√©bitos (locales, valores, exterior)</p>
                   </div>
            
            <!-- √Årea de subida de archivos -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Arrastra tu PDF aqu√≠ o haz clic para seleccionar</div>
                <div class="upload-subtext">Formatos soportados: PDF</div>
                <button class="btn-upload" type="button" onclick="document.getElementById('fileInput').click()">
                    Seleccionar Archivo
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".pdf">
            </div>
            
            <!-- Informaci√≥n del archivo seleccionado -->
            <div class="file-info" id="fileInfo">
                <h4>Archivo seleccionado:</h4>
                <p id="fileName"></p>
                <button class="btn-analyze" id="analyzeBtn" onclick="analyzePDF()">
                    üîç Analizar con IA
                </button>
            </div>
            
            <!-- Mensajes de estado -->
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            
            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analizando PDF con Claude Sonnet 4.5...</p>
                <p><small>Esto puede tomar unos segundos</small></p>
            </div>
            
            <!-- Resultados -->
            <div class="results-container" id="resultsContainer">
                <h2>üìä Resultados del An√°lisis</h2>
                <div class="results-grid" id="resultsGrid">
                    <!-- Los resultados se cargar√°n aqu√≠ din√°micamente -->
                </div>
            </div>
        </div>
    </div>

<script>
    let selectedFile = null;
    let pageStartTime = Date.now();
    
    // Elementos del DOM
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const loading = document.getElementById('loading');
    const resultsContainer = document.getElementById('resultsContainer');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const resultsGrid = document.getElementById('resultsGrid');
    
    // ===== TRACKING AUTOM√ÅTICO DE M√âTRICAS =====
    
    // Variables globales para tracking
    let sessionData = {
        device: detectDevice(),
        userAgent: navigator.userAgent,
        screenResolution: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
    };
    
    // Detectar tipo de dispositivo
    function detectDevice() {
        const userAgent = navigator.userAgent.toLowerCase();
        if (/tablet|ipad/.test(userAgent)) return 'tablet';
        if (/mobile|android|iphone/.test(userAgent)) return 'mobile';
        return 'desktop';
    }
    
    // Funci√≥n para registrar m√©tricas
    async function trackMetric(herramienta, accion, metadatos = {}) {
        try {
            const metricData = {
                herramienta: herramienta,
                accion: accion,
                metadatos: JSON.stringify({
                    ...metadatos,
                    ...sessionData,
                    timestamp: new Date().toISOString()
                })
            };
            
            await fetch('/api/track-metric', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(metricData)
            });
        } catch (error) {
            console.log('Error tracking metric:', error);
        }
    }
    
    // ===== TRACKING DE TIEMPO DE P√ÅGINA =====
    
    // Registrar tiempo al cargar la p√°gina
    trackMetric('analizar_pdf', 'page_load', {
        loadTime: Date.now() - pageStartTime
    });
    
    // Registrar tiempo al salir de la p√°gina
    window.addEventListener('beforeunload', function() {
        const timeSpent = Date.now() - pageStartTime;
        trackMetric('analizar_pdf', 'page_exit', {
            timeSpent: timeSpent,
            timeSpentMinutes: Math.round(timeSpent / 1000 / 60 * 100) / 100
        });
    });
    
    // ===== TRACKING DE CLICKS EN BOTONES =====
    
    // Tracking de clicks en botones principales
    document.addEventListener('click', function(event) {
        if (event.target.id === 'analyzeBtn') {
            trackMetric('analizar_pdf', 'button_click', {
                button: 'analyze',
                hasFile: !!selectedFile
            });
        } else if (event.target.id === 'uploadBtn') {
            trackMetric('analizar_pdf', 'button_click', {
                button: 'upload',
                hasFile: !!selectedFile
            });
        }
    });
        
        // Event listeners para drag & drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        // Click en el √°rea de subida (solo si no es el bot√≥n)
        uploadArea.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') {
                fileInput.click();
            }
        });
        
        // Cambio en el input de archivo
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        function handleFile(file) {
            // Validar que sea PDF
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showError('Por favor selecciona un archivo PDF v√°lido');
                return;
            }
            
            // Validar tama√±o (m√°ximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('El archivo es demasiado grande. M√°ximo 10MB');
                return;
            }
            
            selectedFile = file;
            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            analyzeBtn.style.display = 'inline-block';
            hideMessages();
        }
        
        async function analyzePDF() {
            if (!selectedFile) {
                showError('Por favor selecciona un archivo primero');
                return;
            }
            
            // Mostrar loading
            loading.style.display = 'block';
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Analizando...';
            hideMessages();
            
            // Crear FormData
            const formData = new FormData();
            formData.append('pdf_file', selectedFile);
            
            try {
                const response = await fetch('/analizar-pdf', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                const responseText = await response.text();
                console.log('Response text:', responseText.substring(0, 500));
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    showError('Error: El servidor devolvi√≥ una respuesta inv√°lida');
                    return;
                }
                
                console.log('Parsed result:', result);
                
                   if (result.status === 'success') {
                       showResults(result.data, 'texto');
                       showSuccess('PDF analizado exitosamente con Claude Haiku 4.5 (M√©todo: Texto)');
                       
                       // Tracking de an√°lisis exitoso
                       trackMetric('analizar_pdf', 'analisis_exitoso', {
                           fileSize: selectedFile ? selectedFile.size : 0,
                           fileName: selectedFile ? selectedFile.name : 'unknown',
                           analysisTime: Date.now() - pageStartTime
                       });
                   } else if (result.fecha_corte) {
                       // Si no hay status pero hay datos, mostrar directamente
                       showResults(result, 'texto');
                       showSuccess('PDF analizado exitosamente con Claude Haiku 4.5 (M√©todo: Texto)');
                       
                       // Tracking de an√°lisis exitoso
                       trackMetric('analizar_pdf', 'analisis_exitoso', {
                           fileSize: selectedFile ? selectedFile.size : 0,
                           fileName: selectedFile ? selectedFile.name : 'unknown',
                           analysisTime: Date.now() - pageStartTime
                       });
                   } else {
                       showError(result.message || 'Error analizando el PDF');
                       
                       // Tracking de an√°lisis fallido
                       trackMetric('analizar_pdf', 'analisis_fallido', {
                           error: result.message || 'Error desconocido',
                           fileSize: selectedFile ? selectedFile.size : 0,
                           fileName: selectedFile ? selectedFile.name : 'unknown'
                       });
                   }
                
            } catch (error) {
                console.error('Fetch error:', error);
                showError('Error de conexi√≥n: ' + error.message);
            } finally {
                loading.style.display = 'none';
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'üîç Analizar con IA';
            }
        }
        
        function showResults(data, method) {
            resultsContainer.style.display = 'block';
            resultsGrid.innerHTML = '';
            
            // Mostrar m√©todo usado
            const methodInfo = document.createElement('div');
            methodInfo.className = 'method-used';
            methodInfo.innerHTML = `<h3>üìù An√°lisis por Texto</h3>`;
            resultsContainer.insertBefore(methodInfo, resultsGrid);
            
            const fields = [
                { key: 'fecha_corte', label: 'Fecha de Corte', type: 'date' },
                { key: 'fecha_pago', label: 'Fecha de Pago', type: 'date' },
                { key: 'cupo_autorizado', label: 'Cupo Autorizado', type: 'currency' },
                { key: 'cupo_disponible', label: 'Cupo Disponible', type: 'currency' },
                { key: 'cupo_utilizado', label: 'Cupo Utilizado', type: 'currency' },
                { key: 'deuda_anterior', label: 'Deuda Anterior', type: 'currency' },
                { key: 'consumos_debitos', label: 'Consumos/D√©bitos', type: 'currency' },
                { key: 'otros_cargos', label: 'Otros Cargos', type: 'currency' },
                { key: 'consumos_cargos_totales', label: 'Consumos y Cargos Totales', type: 'currency' },
                { key: 'pagos_creditos', label: 'Pagos/Cr√©ditos', type: 'currency' },
                { key: 'intereses', label: 'Intereses', type: 'currency' },
                { key: 'deuda_total_pagar', label: 'Deuda Total a Pagar', type: 'currency' },
                { key: 'nombre_banco', label: 'Nombre del Banco', type: 'text' },
                { key: 'tipo_tarjeta', label: 'Tipo de Tarjeta', type: 'text' },
                { key: 'ultimos_digitos', label: '√öltimos D√≠gitos', type: 'text' }
            ];
            
            fields.forEach(field => {
                const value = data[field.key];
                if (value !== undefined && value !== null) {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    
                    let displayValue = value;
                    let valueClass = 'result-value';
                    
                    if (field.type === 'currency') {
                        displayValue = `$${parseFloat(value).toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
                        if (parseFloat(value) < 0) {
                            valueClass += ' negative';
                        }
                    } else if (field.type === 'date') {
                        valueClass += ' date';
                    }
                    
                    card.innerHTML = `
                        <h4>${field.label}</h4>
                        <div class="${valueClass}">${displayValue}</div>
                    `;
                    
                    resultsGrid.appendChild(card);
                }
            });
            
            // Agregar porcentaje de utilizaci√≥n si est√° disponible
            if (data.porcentaje_utilizacion !== undefined) {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <h4>Porcentaje de Utilizaci√≥n</h4>
                    <div class="result-value">${data.porcentaje_utilizacion}%</div>
                `;
                resultsGrid.appendChild(card);
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }
        
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }
        
        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }
        
           // Funci√≥n de pesta√±as eliminada - solo usamos m√©todo de texto
    </script>
</body>
</html>
