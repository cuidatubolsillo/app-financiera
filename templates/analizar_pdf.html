<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizar Estado de Cuenta - App Financiera</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='unified-style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 3px dashed var(--verde-vital);
            border-radius: 15px;
            padding: 50px 40px;
            text-align: center;
            background: linear-gradient(135deg, rgba(123, 167, 78, 0.05) 0%, rgba(76, 165, 179, 0.05) 100%);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(123, 167, 78, 0.1);
        }
        
        .upload-area:hover {
            border-color: var(--fondo-intermedio);
            background: linear-gradient(135deg, rgba(123, 167, 78, 0.1) 0%, rgba(76, 165, 179, 0.1) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(123, 167, 78, 0.2);
        }
        
        .upload-area.dragover {
            border-color: var(--verde-vital);
            background: linear-gradient(135deg, rgba(123, 167, 78, 0.15) 0%, rgba(76, 165, 179, 0.15) 100%);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 64px;
            color: var(--verde-vital);
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .upload-text {
            font-size: 1.2rem;
            color: var(--texto-oscuro);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .upload-subtext {
            font-size: 0.95rem;
            color: var(--gris-oscuro);
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .btn-upload {
            background: linear-gradient(135deg, var(--verde-vital) 0%, var(--azul-util) 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(123, 167, 78, 0.3);
        }
        
        .btn-upload:hover {
            background: linear-gradient(135deg, var(--fondo-intermedio) 0%, var(--verde-vital) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(123, 167, 78, 0.4);
        }
        
        .btn-analyze {
            background: linear-gradient(135deg, var(--verde-vital) 0%, var(--azul-util) 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 15px;
            display: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(123, 167, 78, 0.3);
        }
        
        .btn-analyze:hover {
            background: linear-gradient(135deg, var(--fondo-intermedio) 0%, var(--verde-vital) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(123, 167, 78, 0.4);
        }
        
        .btn-analyze:disabled {
            background: linear-gradient(135deg, var(--gris-claro) 0%, var(--gris-oscuro) 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .file-info {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--verde-vital);
        }
        
        .loading {
            text-align: center;
            padding: 50px 20px;
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 30px 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .spinner {
            border: 5px solid rgba(123, 167, 78, 0.2);
            border-top: 5px solid var(--verde-vital);
            border-right: 5px solid var(--azul-util);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        .loading p {
            font-size: 1.2rem;
            color: var(--texto-oscuro);
            font-weight: 600;
            margin: 0;
        }
        
        .loading p small {
            font-size: 0.9rem;
            color: var(--gris-oscuro);
            font-weight: 400;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading .spinner {
            animation: spin 1s linear infinite, pulse 2s ease-in-out infinite;
        }
        
        .results-container {
            display: none;
        }
        
        .results-container.active {
            display: block;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        /* Estilos para grupos de detalles */
        .details-group {
            margin-bottom: 25px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .details-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }
        
        .group-title {
            margin: 0 0 20px 0;
            color: var(--texto-oscuro);
            font-size: 1.3em;
            font-weight: 700;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--gris-claro);
        }
        
        .grupo-cabecera {
            border-left: 5px solid var(--azul-util);
        }
        
        .grupo-1 {
            border-left: 5px solid var(--azul-util);
        }
        
        .grupo-2 {
            border-left: 5px solid var(--verde-vital);
        }
        
        .grupo-3 {
            border-left: 5px solid var(--dorado);
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .detail-card {
            background: linear-gradient(135deg, rgba(123, 167, 78, 0.05) 0%, rgba(76, 165, 179, 0.05) 100%);
            padding: 18px;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 2px solid rgba(123, 167, 78, 0.2);
        }
        
        .detail-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(123, 167, 78, 0.2);
            border-color: var(--verde-vital);
            background: linear-gradient(135deg, rgba(123, 167, 78, 0.1) 0%, rgba(76, 165, 179, 0.1) 100%);
        }
        
        .detail-card.highlight {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 215, 0, 0.2) 100%);
            border: 2px solid var(--dorado);
        }
        
        .detail-label {
            font-size: 0.85em;
            color: var(--gris-oscuro);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .detail-value {
            font-weight: 700;
            color: var(--texto-oscuro);
            font-size: 1.2em;
        }
        
        .detail-value.currency {
            color: var(--azul-util);
            font-size: 1.3em;
        }
        
        .detail-value.highlight-value {
            color: #d32f2f;
            font-size: 1.5em;
            font-weight: 800;
        }
        
        .detail-value.date {
            color: var(--azul-util);
        }
        
        .result-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .result-card h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .result-value {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }
        
        .result-value.date {
            color: #007bff;
        }
        
        .result-value.negative {
            color: #dc3545;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: none;
        }
        
        .back-button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .back-button:hover {
            background-color: #5a6268;
            color: white;
            text-decoration: none;
        }
        
        /* Pesta√±as de m√©todos */
        .method-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .tab-button {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        
        .tab-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        /* Contador de usos de IA */
        .usage-counter {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .usage-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .usage-label {
            font-weight: 600;
            color: #495057;
        }
        
        .usage-count {
            background-color: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .usage-count.low {
            background-color: #ffc107;
            color: #212529;
        }
        
        .usage-count.exhausted {
            background-color: #dc3545;
        }
        
        /* Modal para guardar estado de cuenta */
        .save-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .save-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .save-modal h3 {
            color: #2c5530;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .save-modal p {
            color: #666;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .save-benefits {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        
        .save-benefits p {
            margin: 0 0 10px 0;
            color: #495057;
            text-align: left;
        }
        
        .save-benefits ul {
            margin: 0;
            padding-left: 20px;
            color: #6c757d;
        }
        
        .save-benefits li {
            margin: 5px 0;
        }
        
        .save-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .btn-save {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .btn-save:hover {
            background: #1e7e34;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .duplicate-modal-content {
            max-width: 600px;
        }
        
        .success-modal-content {
            border-left: 4px solid #28a745;
            text-align: center;
        }
        
        .success-message {
            padding: 20px;
            background-color: #d4edda;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
        
        .success-message p {
            color: #155724;
            font-weight: 500;
            margin: 0;
        }
        
        .duplicate-warning {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .duplicate-warning p {
            margin: 10px 0;
            color: #856404;
            text-align: left;
        }
        
        .duplicate-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        
        .duplicate-info p {
            margin: 8px 0;
            color: #495057;
        }
        
        .duplicate-info strong {
            color: #856404;
        }
        
        .duplicate-question {
            font-weight: 600;
            color: #856404 !important;
            margin-top: 15px !important;
            text-align: center !important;
        }
        
        .btn-overwrite {
            background: #ffc107;
            color: #856404;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .btn-overwrite:hover {
            background: #e0a800;
            transition: background 0.3s;
        }
        
        .btn-cancel:hover {
            background: #5a6268;
        }
        
        /* Bot√≥n de guardar grande en la parte inferior */
        .save-button-container {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }
        
        .btn-save-large {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        
        .btn-save-large:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
        }
        
        .btn-save:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="unified-container">
        <a href="{{ url_for('home') }}" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Volver al Men√∫ Principal
        </a>
        
        <div class="unified-header">
            <h1>
                <i class="fas fa-robot"></i>
                Analizar Estado de Cuenta con IA
            </h1>
            <p>Sube tu estado de cuenta en PDF y obt√©n un an√°lisis completo con inteligencia artificial</p>
        </div>
        
        <div class="unified-content">
            <!-- √Årea de subida de archivos -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Arrastra tu PDF aqu√≠ o haz clic para seleccionar</div>
                <div class="upload-subtext">Formatos soportados: PDF</div>
                <button class="btn-upload" type="button" onclick="document.getElementById('fileInput').click()">
                    Seleccionar Archivo
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".pdf">
            </div>
            
            <!-- Informaci√≥n del archivo seleccionado -->
            <div class="file-info" id="fileInfo">
                <h4>Archivo seleccionado:</h4>
                <p id="fileName"></p>
                <button class="btn-analyze" id="analyzeBtn" onclick="analyzePDF()">
                    üîç Analizar con IA
                </button>
            </div>
            
            <!-- Mensajes de estado -->
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            
            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner-container">
                    <div class="spinner"></div>
                    <p>Analizando tu estado de cuenta...</p>
                    <p><small>Por favor espera, esto puede tomar unos momentos</small></p>
                </div>
            </div>
            
            <!-- Resultados -->
            <div class="results-container" id="resultsContainer">
                <h2 class="section-title">üìä Resultados del An√°lisis</h2>
                <!-- Los resultados se mostrar√°n aqu√≠ con grupos de cards -->
            </div>
        </div>
    </div>
    
    <!-- Modal para guardar estado de cuenta -->
    <div id="saveModal" class="save-modal">
        <div class="save-modal-content">
            <h3>üíæ Guardar An√°lisis</h3>
            <p>¬øDesea guardar este an√°lisis en su historial de estados de cuenta?</p>
            <div class="save-benefits">
                <p><strong>‚úÖ Beneficios de guardar:</strong></p>
                <ul>
                    <li>Acceso r√°pido desde el historial</li>
                    <li>Comparaci√≥n con estados anteriores</li>
                    <li>Control de pagos de tarjeta</li>
                </ul>
            </div>
            <div class="save-modal-buttons">
                <button class="btn-save" id="btnSave" onclick="guardarEstadoCuenta()">
                    üíæ Guardar en Historial
                </button>
                <button class="btn-cancel" onclick="cerrarModalGuardar()">
                    ‚ùå No Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para alerta de duplicado -->
    <div id="duplicateModal" class="save-modal">
        <div class="save-modal-content duplicate-modal-content">
            <h3>‚ö†Ô∏è Estado de Cuenta Duplicado</h3>
            <div class="duplicate-warning">
                <p><strong>Estimado usuario,</strong></p>
                <p>El estado de cuenta que intenta guardar ya existe en su historial:</p>
                <div class="duplicate-info">
                    <p><strong>Banco:</strong> <span id="duplicate-banco"></span></p>
                    <p><strong>Tarjeta:</strong> <span id="duplicate-tarjeta"></span></p>
                    <p><strong>Fecha de Corte:</strong> <span id="duplicate-fecha-corte"></span></p>
                    <p><strong>√öltimos D√≠gitos:</strong> <span id="duplicate-digitos"></span></p>
                    <p><strong>Guardado el:</strong> <span id="duplicate-fecha-creacion"></span></p>
                </div>
                <p class="duplicate-question">¬øDesea sobrescribir el estado de cuenta existente?</p>
            </div>
            <div class="save-modal-buttons">
                <button class="btn-overwrite" id="btnOverwrite" onclick="sobrescribirEstadoCuenta()">
                    ‚úÖ S√≠, Sobrescribir
                </button>
                <button class="btn-cancel" onclick="cerrarModalDuplicado()">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de √©xito -->
    <div id="successModal" class="save-modal">
        <div class="save-modal-content success-modal-content">
            <h3>‚úÖ ¬°Guardado Exitoso!</h3>
            <div class="success-message">
                <p id="success-message-text">El estado de cuenta se ha guardado correctamente en tu historial.</p>
            </div>
            <div class="save-modal-buttons">
                <button class="btn-save" onclick="cerrarModalExito()">
                    OK
                </button>
            </div>
        </div>
    </div>

<script>
    let selectedFile = null;
    let pageStartTime = Date.now();
    let currentAnalysisData = null; // Para almacenar los datos del an√°lisis actual
    let isSaving = false; // Bandera para prevenir doble guardado
    let isSaved = false; // Bandera para indicar si ya se guard√≥
    
    // Elementos del DOM
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const loading = document.getElementById('loading');
    const resultsContainer = document.getElementById('resultsContainer');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    // resultsGrid ya no se usa, ahora usamos grupos directamente en resultsContainer
    
    // ===== TRACKING AUTOM√ÅTICO DE M√âTRICAS =====
    
    // Variables globales para tracking
    let sessionData = {
        device: detectDevice(),
        userAgent: navigator.userAgent,
        screenResolution: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
    };
    
    // Detectar tipo de dispositivo
    function detectDevice() {
        const userAgent = navigator.userAgent.toLowerCase();
        if (/tablet|ipad/.test(userAgent)) return 'tablet';
        if (/mobile|android|iphone/.test(userAgent)) return 'mobile';
        return 'desktop';
    }
    
    // Funci√≥n para registrar m√©tricas
    async function trackMetric(herramienta, accion, metadatos = {}) {
        try {
            const metricData = {
                herramienta: herramienta,
                accion: accion,
                metadatos: JSON.stringify({
                    ...metadatos,
                    ...sessionData,
                    timestamp: new Date().toISOString()
                })
            };
            
            await fetch('/api/track-metric', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(metricData)
            });
        } catch (error) {
            console.log('Error tracking metric:', error);
        }
    }
    
    // ===== TRACKING DE TIEMPO DE P√ÅGINA =====
    
    // Registrar tiempo al cargar la p√°gina
    trackMetric('analizar_pdf', 'page_load', {
        loadTime: Date.now() - pageStartTime
    });
    
    // Registrar tiempo al salir de la p√°gina
    window.addEventListener('beforeunload', function() {
        const timeSpent = Date.now() - pageStartTime;
        trackMetric('analizar_pdf', 'page_exit', {
            timeSpent: timeSpent,
            timeSpentMinutes: Math.round(timeSpent / 1000 / 60 * 100) / 100
        });
    });
    
    // ===== TRACKING DE CLICKS EN BOTONES =====
    
    // Tracking de clicks en botones principales
    document.addEventListener('click', function(event) {
        if (event.target.id === 'analyzeBtn') {
            trackMetric('analizar_pdf', 'button_click', {
                button: 'analyze',
                hasFile: !!selectedFile
            });
        } else if (event.target.id === 'uploadBtn') {
            trackMetric('analizar_pdf', 'button_click', {
                button: 'upload',
                hasFile: !!selectedFile
            });
        }
    });
        
        // Event listeners para drag & drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        // Click en el √°rea de subida (solo si no es el bot√≥n)
        uploadArea.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') {
                fileInput.click();
            }
        });
        
        // Cambio en el input de archivo
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        function handleFile(file) {
            // Validar que sea PDF
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showError('Por favor selecciona un archivo PDF v√°lido');
                return;
            }
            
            // Validar tama√±o (m√°ximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('El archivo es demasiado grande. M√°ximo 10MB');
                return;
            }
            
            // Limpiar resultados anteriores al seleccionar un nuevo archivo
            resultsContainer.innerHTML = '';
            resultsContainer.classList.remove('active');
            currentAnalysisData = null;
            isSaving = false; // Resetear bandera de guardado
            isSaved = false; // Resetear bandera de guardado completado
            
            selectedFile = file;
            fileName.textContent = file.name;
            fileInfo.style.display = 'block';
            analyzeBtn.style.display = 'inline-block';
            hideMessages();
        }
        
        async function analyzePDF() {
            if (!selectedFile) {
                showError('Por favor selecciona un archivo primero');
                return;
            }
            
            // Limpiar resultados anteriores
            resultsContainer.innerHTML = '';
            resultsContainer.classList.remove('active');
            currentAnalysisData = null;
            isSaving = false; // Resetear bandera de guardado
            isSaved = false; // Resetear bandera de guardado completado
            
            // Mostrar loading
            loading.classList.add('active');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Analizando...';
            hideMessages();
            
            // Crear FormData
            const formData = new FormData();
            formData.append('pdf_file', selectedFile);
            
            try {
                const response = await fetch('/analizar-pdf', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                const responseText = await response.text();
                console.log('Response text:', responseText.substring(0, 500));
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    showError('Error: El servidor devolvi√≥ una respuesta inv√°lida');
                    return;
                }
                
                console.log('Parsed result:', result);
                
                   if (result.status === 'success') {
                       showResults(result.data, 'texto');
                       showSuccess('‚úÖ Estado de cuenta analizado exitosamente');
                       
                       // Tracking de an√°lisis exitoso
                       trackMetric('analizar_pdf', 'analisis_exitoso', {
                           fileSize: selectedFile ? selectedFile.size : 0,
                           fileName: selectedFile ? selectedFile.name : 'unknown',
                           analysisTime: Date.now() - pageStartTime
                       });
                   } else if (result.fecha_corte) {
                       // Si no hay status pero hay datos, mostrar directamente
                       showResults(result, 'texto');
                       showSuccess('‚úÖ Estado de cuenta analizado exitosamente');
                       
                       // Tracking de an√°lisis exitoso
                       trackMetric('analizar_pdf', 'analisis_exitoso', {
                           fileSize: selectedFile ? selectedFile.size : 0,
                           fileName: selectedFile ? selectedFile.name : 'unknown',
                           analysisTime: Date.now() - pageStartTime
                       });
                   } else {
                       showError(result.message || 'Error analizando el PDF');
                       
                       // Tracking de an√°lisis fallido
                       trackMetric('analizar_pdf', 'analisis_fallido', {
                           error: result.message || 'Error desconocido',
                           fileSize: selectedFile ? selectedFile.size : 0,
                           fileName: selectedFile ? selectedFile.name : 'unknown'
                       });
                   }
                
            } catch (error) {
                console.error('Fetch error:', error);
                showError('Error de conexi√≥n: ' + error.message);
            } finally {
                loading.classList.remove('active');
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'üîç Analizar con IA';
            }
        }
        
        function showResults(data, method) {
            // Guardar los datos del an√°lisis para poder guardarlos despu√©s
            currentAnalysisData = data;
            
            resultsContainer.classList.add('active');
            resultsContainer.innerHTML = ''; // Limpiar contenedor
            
            // Grupo 1: Fechas
            const grupo1Fields = [
                { key: 'fecha_inicio_periodo', label: 'Fecha Inicio Periodo', type: 'date' },
                { key: 'fecha_corte', label: 'Fecha de Corte', type: 'date' },
                { key: 'fecha_pago', label: 'Fecha de Pago', type: 'date' }
            ];
            
            // Grupo 2: Cupos
            const grupo2Fields = [
                { key: 'cupo_autorizado', label: 'Cupo Autorizado', type: 'currency' },
                { key: 'cupo_disponible', label: 'Cupo Disponible', type: 'currency' },
                { key: 'cupo_utilizado', label: 'Cupo Utilizado', type: 'currency' }
            ];
            
            // Grupo 3: Totales y Deudas
            const grupo3Fields = [
                { key: 'deuda_anterior', label: 'Deuda Anterior', type: 'currency' },
                { key: 'consumos_cargos_totales', label: 'Consumos y Cargos', type: 'currency' },
                { key: 'pagos_creditos', label: 'Pagos y Cr√©ditos', type: 'currency' },
                { key: 'intereses', label: 'Intereses', type: 'currency' },
                { key: 'minimo_a_pagar', label: 'M√≠nimo a Pagar', type: 'currency' },
                { key: 'deuda_total_pagar', label: 'Deuda Total a Pagar', type: 'currency', highlight: true }
            ];
            
            // Cabecera (siempre visible)
            const cabeceraFields = [
                { key: 'nombre_banco', label: 'Nombre del Banco', type: 'text' },
                { key: 'tipo_tarjeta', label: 'Tipo de Tarjeta', type: 'text' },
                { key: 'ultimos_digitos', label: '√öltimos D√≠gitos', type: 'text' }
            ];
            
            // Agregar porcentaje de utilizaci√≥n a la cabecera si est√° disponible
            if (data.porcentaje_utilizacion !== undefined && data.porcentaje_utilizacion !== null) {
                cabeceraFields.push({ 
                    key: 'porcentaje_utilizacion', 
                    label: 'Porcentaje de Utilizaci√≥n', 
                    type: 'text',
                    displayValue: data.porcentaje_utilizacion + '%'
                });
            }
            
            // Funci√≥n para crear cards de un grupo
            function createGroupCards(fields, groupTitle, groupClass) {
                const groupDiv = document.createElement('div');
                groupDiv.className = `details-group ${groupClass}`;
                groupDiv.innerHTML = `<h4 class="group-title">${groupTitle}</h4><div class="details-grid"></div>`;
                const grid = groupDiv.querySelector('.details-grid');
                
                fields.forEach(field => {
                    let value = data[field.key];
                    if (field.displayValue !== undefined) {
                        value = field.displayValue;
                    }
                    
                    if (value !== undefined && value !== null && value !== '') {
                        const card = document.createElement('div');
                        card.className = field.highlight ? 'detail-card highlight' : 'detail-card';
                        
                        let displayValue = value;
                        let valueClass = 'detail-value';
                        
                        if (field.type === 'currency') {
                            displayValue = `$${parseFloat(value).toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
                            valueClass += ' currency';
                            if (field.highlight) {
                                valueClass += ' highlight-value';
                            }
                        } else if (field.type === 'date') {
                            valueClass += ' date';
                        }
                        
                        card.innerHTML = `
                            <div class="detail-label">${field.label}</div>
                            <div class="${valueClass}">${displayValue}</div>
                        `;
                        
                        grid.appendChild(card);
                    }
                });
                
                if (grid.children.length > 0) {
                    resultsContainer.appendChild(groupDiv);
                }
            }
            
            // Crear grupos
            createGroupCards(cabeceraFields, 'üè¶ Informaci√≥n de la Tarjeta', 'grupo-cabecera');
            createGroupCards(grupo1Fields, 'üìÖ Fechas del Periodo', 'grupo-1');
            createGroupCards(grupo2Fields, 'üí≥ Informaci√≥n de Cupo', 'grupo-2');
            createGroupCards(grupo3Fields, 'üí∞ Totales y Pagos', 'grupo-3');
            
            // Agregar bot√≥n de guardar en la parte inferior
            const saveButtonContainer = document.createElement('div');
            saveButtonContainer.className = 'save-button-container';
            const buttonText = isSaved ? '‚úÖ Ya Guardado' : 'üíæ Guardar Estado de Cuenta';
            const buttonDisabled = isSaved ? 'disabled' : '';
            const buttonStyle = isSaved ? 'style="opacity: 0.6; cursor: not-allowed;"' : '';
            saveButtonContainer.innerHTML = `
                <button class="btn-save-large" onclick="mostrarModalGuardar()" ${buttonDisabled} ${buttonStyle}>
                    ${buttonText}
                </button>
            `;
            resultsContainer.appendChild(saveButtonContainer);
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }
        
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }
        
        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }
        
        // ===== FUNCIONES DEL MODAL DE GUARDAR =====
        
        function mostrarModalGuardar() {
            // Prevenir mostrar el modal si ya se guard√≥ o se est√° guardando
            if (isSaved || isSaving) {
                console.log('Ya se guard√≥ o se est√° guardando, no mostrar modal');
                return;
            }
            document.getElementById('saveModal').style.display = 'block';
        }
        
        function cerrarModalGuardar() {
            document.getElementById('saveModal').style.display = 'none';
            // NO limpiar currentAnalysisData aqu√≠ para permitir reintentos
        }
        
        function mostrarModalExito(mensaje) {
            const successModal = document.getElementById('successModal');
            const messageText = document.getElementById('success-message-text');
            if (messageText) {
                messageText.textContent = mensaje;
            }
            successModal.style.display = 'block';
        }
        
        function cerrarModalExito() {
            document.getElementById('successModal').style.display = 'none';
        }
        
        let estadoCuentaDuplicadoId = null; // Para almacenar el ID del estado duplicado

        async function guardarEstadoCuenta() {
            // Prevenir doble guardado
            if (isSaving) {
                console.log('Ya se est√° guardando, ignorar segundo intento');
                return;
            }
            
            if (isSaved) {
                console.log('Ya se guard√≥, no permitir guardado duplicado');
                cerrarModalGuardar();
                return;
            }
            
            if (!currentAnalysisData) {
                showError('No hay datos de an√°lisis para guardar');
                cerrarModalGuardar();
                return;
            }
            
            // Marcar que se est√° guardando
            isSaving = true;
            
            const btnSave = document.getElementById('btnSave');
            const saveModal = document.getElementById('saveModal');
            
            // Deshabilitar bot√≥n y mostrar estado de carga
            btnSave.disabled = true;
            btnSave.textContent = 'üíæ Guardando...';
            
            try {
                const response = await fetch('/api/guardar-estado-cuenta', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        datos_analisis: currentAnalysisData,
                        archivo_original: selectedFile ? selectedFile.name : null
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Resultado del guardado:', result);
                
                if (result.status === 'success') {
                    // Marcar como guardado
                    isSaved = true;
                    isSaving = false;
                    
                    // Cerrar modal de guardar INMEDIATAMENTE
                    if (saveModal) {
                        saveModal.style.display = 'none';
                    }
                    cerrarModalGuardar(); // Asegurar que se cierre
                    
                    // Deshabilitar el bot√≥n de "Guardar Estado de Cuenta" en la p√°gina
                    const saveButtonLarge = document.querySelector('.btn-save-large');
                    if (saveButtonLarge) {
                        saveButtonLarge.disabled = true;
                        saveButtonLarge.textContent = '‚úÖ Ya Guardado';
                        saveButtonLarge.style.opacity = '0.6';
                        saveButtonLarge.style.cursor = 'not-allowed';
                        saveButtonLarge.onclick = null; // Remover el evento onclick
                    }
                    
                    // NO limpiar currentAnalysisData aqu√≠ para mantener los datos visibles
                    // pero marcar como guardado para prevenir guardados duplicados
                    
                    // Mostrar modal de √©xito DESPU√âS de cerrar el modal de guardar
                    setTimeout(() => {
                        mostrarModalExito('El estado de cuenta se ha guardado correctamente en tu historial.');
                    }, 100);
                    
                    // Tracking de guardado exitoso
                    trackMetric('analizar_pdf', 'estado_guardado', {
                        banco: result.banco || 'N/A',
                        tarjeta: result.tarjeta || 'N/A',
                        fecha_corte: result.fecha_corte || 'N/A'
                    });
                    
                    // NO restaurar el bot√≥n en caso de √©xito
                    return;
                } else if (result.status === 'duplicate') {
                    // Estado de cuenta duplicado - mostrar modal de confirmaci√≥n
                    estadoCuentaDuplicadoId = result.estado_cuenta_existente.id;
                    mostrarModalDuplicado(result.estado_cuenta_existente);
                } else {
                    showError('Error guardando estado de cuenta: ' + (result.message || 'Error desconocido'));
                }
                
            } catch (error) {
                console.error('Error guardando estado:', error);
                showError('Error de conexi√≥n al guardar: ' + error.message);
                // Si hay error, permitir reintento
                isSaving = false;
            } finally {
                // Solo restaurar el bot√≥n si NO fue exitoso y NO est√° guardado
                if (!isSaved && btnSave && btnSave.textContent === 'üíæ Guardando...') {
                    btnSave.disabled = false;
                    btnSave.textContent = 'üíæ Guardar';
                    isSaving = false; // Permitir reintento
                }
            }
        }
        
        function mostrarModalDuplicado(estadoExistente) {
            // Cerrar modal de guardar
            cerrarModalGuardar();
            
            // Llenar informaci√≥n del estado existente
            document.getElementById('duplicate-banco').textContent = estadoExistente.banco || 'N/A';
            document.getElementById('duplicate-tarjeta').textContent = estadoExistente.tarjeta || 'N/A';
            document.getElementById('duplicate-fecha-corte').textContent = estadoExistente.fecha_corte || 'N/A';
            document.getElementById('duplicate-digitos').textContent = estadoExistente.ultimos_digitos || 'N/A';
            document.getElementById('duplicate-fecha-creacion').textContent = estadoExistente.fecha_creacion || 'N/A';
            
            // Mostrar modal de duplicado
            document.getElementById('duplicateModal').style.display = 'block';
        }
        
        function cerrarModalDuplicado() {
            document.getElementById('duplicateModal').style.display = 'none';
            estadoCuentaDuplicadoId = null;
        }
        
        async function sobrescribirEstadoCuenta() {
            if (!currentAnalysisData || !estadoCuentaDuplicadoId) {
                showError('No hay datos para sobrescribir');
                return;
            }
            
            const btnOverwrite = document.getElementById('btnOverwrite');
            const duplicateModal = document.getElementById('duplicateModal');
            
            btnOverwrite.disabled = true;
            btnOverwrite.textContent = '‚è≥ Sobrescribiendo...';
            
            try {
                const response = await fetch('/api/guardar-estado-cuenta', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        datos_analisis: currentAnalysisData,
                        archivo_original: selectedFile ? selectedFile.name : null,
                        sobrescribir: true,
                        estado_cuenta_id_sobrescribir: estadoCuentaDuplicadoId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Resultado del sobrescritura:', result);
                
                if (result.status === 'success') {
                    // Marcar como guardado
                    isSaved = true;
                    isSaving = false;
                    
                    // Cerrar modal de duplicado INMEDIATAMENTE
                    if (duplicateModal) {
                        duplicateModal.style.display = 'none';
                    }
                    cerrarModalDuplicado(); // Asegurar que se cierre
                    
                    // Deshabilitar el bot√≥n de "Guardar Estado de Cuenta" en la p√°gina
                    const saveButtonLarge = document.querySelector('.btn-save-large');
                    if (saveButtonLarge) {
                        saveButtonLarge.disabled = true;
                        saveButtonLarge.textContent = '‚úÖ Ya Guardado';
                        saveButtonLarge.style.opacity = '0.6';
                        saveButtonLarge.style.cursor = 'not-allowed';
                        saveButtonLarge.onclick = null; // Remover el evento onclick
                    }
                    
                    // NO limpiar currentAnalysisData aqu√≠ para mantener los datos visibles
                    estadoCuentaDuplicadoId = null;
                    
                    // Mostrar modal de √©xito DESPU√âS de cerrar el modal de duplicado
                    setTimeout(() => {
                        mostrarModalExito('El estado de cuenta se ha actualizado correctamente en tu historial.');
                    }, 100);
                    
                    // Tracking de sobrescritura
                    trackMetric('analizar_pdf', 'estado_sobrescrito', {
                        banco: result.banco || 'N/A',
                        tarjeta: result.tarjeta || 'N/A',
                        fecha_corte: result.fecha_corte || 'N/A'
                    });
                    
                    // NO restaurar el bot√≥n en caso de √©xito
                    return;
                } else {
                    showError('Error sobrescribiendo estado de cuenta: ' + (result.message || 'Error desconocido'));
                }
                
            } catch (error) {
                console.error('Error sobrescribiendo estado:', error);
                showError('Error de conexi√≥n al sobrescribir: ' + error.message);
            } finally {
                // Solo restaurar el bot√≥n si NO fue exitoso
                if (btnOverwrite && btnOverwrite.textContent === '‚è≥ Sobrescribiendo...') {
                    btnOverwrite.disabled = false;
                    btnOverwrite.textContent = '‚úÖ S√≠, Sobrescribir';
                }
            }
        }
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('saveModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalGuardar();
            }
        });
        
        // Cerrar modal de duplicado al hacer clic fuera
        document.getElementById('duplicateModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalDuplicado();
            }
        });
        
           // Funci√≥n de pesta√±as eliminada - solo usamos m√©todo de texto
    </script>
</body>
</html>
